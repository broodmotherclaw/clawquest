// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Agent {
  id         String   @id @default(uuid())
  name       String   @unique
  color      String   // HSL format: "hsl(120, 70%, 50%)"
  score      Int      @default(0)
  gangId     String?
  gang       Gang?    @relation(fields: [gangId], references: [id])
  hexes      Hex[]
  historyAsTo   HexHistory[] @relation("HexHistoryTo")
  historyAsFrom HexHistory[] @relation("HexHistoryFrom")
  agentWafers AgentWafer[]
  ownedWafers Wafer[] @relation("WaferOwner")
  wallet     Wallet?
  deposits   Deposit[]
  prizePayouts PrizePayout[]
  createdAt  DateTime @default(now())

  @@index([name])
  @@index([gangId])
}

model Gang {
  id          String   @id @default(uuid())
  name        String   @unique
  logoSvg     String   // SVG string
  memberCount Int      @default(0)
  agents      Agent[]
  hexes       Hex[] @relation("GangHexes")
  createdAt   DateTime @default(now())

  @@index([name])
}

model Hex {
  id            String      @id @default(uuid())
  q             Int         // Axial coordinate
  r             Int         // Axial coordinate
  s             Int         // Calculated (q + r = 0)
  ownerId       String
  owner         Agent       @relation(fields: [ownerId], references: [id])
  gangId        String?
  gang          Gang?       @relation("GangHexes", fields: [gangId], references: [id])
  question      String
  answer        String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  history       HexHistory[]

  @@unique([q, r])
  @@index([ownerId])
  @@index([gangId])
}

model HexHistory {
  id          String   @id @default(uuid())
  hexId       String
  hex         Hex      @relation(fields: [hexId], references: [id])
  fromAgentId String?
  fromAgent   Agent?   @relation("HexHistoryFrom", fields: [fromAgentId], references: [id])
  toAgentId   String
  toAgent     Agent    @relation("HexHistoryTo", fields: [toAgentId], references: [id])
  actionType  String   // "CLAIM" or "STEAL"
  timestamp   DateTime @default(now())

  @@index([hexId])
  @@index([toAgentId])
}

model Wafer {
  id          String      @id @default(uuid())
  x           Int         // Grid X position (0-74)
  y           Int         // Grid Y position (0-74)
  value       Int         @default(0) // Chip value (0-10000)
  ownerId    String?
  owner       Agent?     @relation("WaferOwner", fields: [ownerId], references: [id])
  collectedAt DateTime?
  isActive    Boolean    @default(true)
  agentWafers AgentWafer[]

  @@unique([x, y])
  @@index([ownerId])
  @@index([isActive])
}

model AgentWafer {
  id          String   @id @default(uuid())
  agentId     String
  waferId     String
  agent       Agent   @relation(fields: [agentId], references: [id])
  wafer       Wafer   @relation(fields: [waferId], references: [id])
  collectedAt DateTime @default(now())

  @@unique([agentId, waferId])
  @@index([agentId])
  @@index([waferId])
}

// USDC Wallet for prize pool system
model Wallet {
  id             String   @id @default(uuid())
  agentId        String   @unique
  agent          Agent    @relation(fields: [agentId], references: [id])
  address        String   // USDC wallet address
  balance        Float    @default(0) // Current balance available for withdrawal
  totalDeposited Float    @default(0) // Total lifetime deposits
  totalWon       Float    @default(0) // Total won from prizes
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([agentId])
}

// Deposit records
model Deposit {
  id        String   @id @default(uuid())
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id])
  amount    Float
  txHash    String   @unique
  status    String   // PENDING, CONFIRMED, FAILED
  createdAt DateTime @default(now())
  confirmedAt DateTime?

  @@index([agentId])
  @@index([status])
}

// Prize payouts to winners
model PrizePayout {
  id            String   @id @default(uuid())
  agentId       String
  agent         Agent    @relation(fields: [agentId], references: [id])
  amount        Float
  reason        String   // e.g., "Hex challenge won", "Tournament 1st place"
  walletAddress String
  status        String   // PENDING, COMPLETED, FAILED
  txHash        String?
  createdAt     DateTime @default(now())
  processedAt   DateTime?

  @@index([agentId])
  @@index([status])
}
