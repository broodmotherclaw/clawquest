name: Deploy Database to Supabase

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/prisma/**'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      database_status: ${{ steps.deploy.outputs.database_status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Prisma CLI
        run: npm install -g prisma
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Generate Prisma Client
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸ”§ Generating Prisma Client..."
          npx prisma generate
      
      - name: Push database schema
        id: deploy
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸš€ Pushing database schema to Supabase..."
          
          # Push schema
          npx prisma db push --skip-generate
          
          # Verify tables
          echo ""
          echo "ðŸ” Verifying tables..."
          npx prisma db pull --force
          
          echo "database_status=connected" >> $GITHUB_OUTPUT
      
      - name: Initialize wafers
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸŒŸ Checking wafers..."
          # Prisma maps model Wafer to table "Wafer" and field isActive to "isActive".
          # Seed once if table exists and is empty.
          WAFER_COUNT=$(npx prisma db execute --stdin --url "$DATABASE_URL" < <(echo 'SELECT COUNT(*) AS count FROM "Wafer";') || true)
          echo "â„¹ï¸  Current wafers count: $WAFER_COUNT"

          if [[ "$WAFER_COUNT" == *"count"* ]] && [[ "$WAFER_COUNT" == *"0"* ]]; then
            echo "ðŸŒŸ Initializing wafers..."
            npx prisma db execute --stdin --url "$DATABASE_URL" < <(echo '
              INSERT INTO "Wafer" ("id","x","y","value","isActive")
              SELECT
                md5(random()::text || gs::text),
                floor(random()*75)::int,
                floor(random()*75)::int,
                floor(random()*100 + 1)::int,
                true
              FROM generate_series(1, 5000) AS gs
              ON CONFLICT ("x","y") DO NOTHING;
            ')
            echo "âœ… Wafer initialization completed"
          else
            echo "â„¹ï¸  Wafers already exist or table not ready, skipping initialization"
          fi
      
      - name: Verify database
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo ""
          echo "ðŸ” Verifying database schema..."
          
          # Check agents table
          AGENT_COUNT=$(npx prisma db execute --stdin --url "$DATABASE_URL" < <(echo 'SELECT COUNT(*) as count FROM "Agent";'))
          echo "   âœ… Agents table: $AGENT_COUNT rows"
          
          # Check wafers table
          WAFER_COUNT=$(npx prisma db execute --stdin --url "$DATABASE_URL" < <(echo 'SELECT COUNT(*) as count FROM "Wafer";'))
          echo "   âœ… Wafers table: $WAFER_COUNT rows"
          
          echo ""
          echo "âœ… Database deployment successful!"
      
      - name: Deployment success
        if: success()
        run: |
          echo "âœ… Database deployed successfully!"
          echo "ðŸŒ Database: Supabase PostgreSQL"
          echo "ðŸ“‹ Schema version: ${{ github.sha }}"
      
      - name: Rollback on failure
        if: failure()
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "âš ï¸  Migration failed. Automatic rollback disabled to prevent destructive reset."
          echo "ðŸ› ï¸  Please inspect logs and fix forward with a new migration/db push."
